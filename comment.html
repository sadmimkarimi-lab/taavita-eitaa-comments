<!DOCTYPE html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <title>اتاق کامنت – Taavita</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body class="page">
    <div class="container">
      <header class="header">
        <div>
          <h1 class="title">اتاق کامنت</h1>
          <p id="roomInfo" class="hint"></p>
        </div>
      </header>

      <main>
        <section id="messages" class="messages"></section>

        <p id="chatStatus" class="hint"></p>

        <form id="commentForm" class="card comment-form">
          <label class="field">
            <span class="label">نام شما:</span>
            <input
              id="nameInput"
              type="text"
              placeholder="مثلاً الهه"
            />
          </label>

          <label class="field">
            <span class="label">متن پیام:</span>
            <textarea
              id="messageInput"
              rows="3"
              placeholder="نظرت را بنویس..."
            ></textarea>
          </label>

          <button
            type="button"
            id="sendBtn"
            class="btn primary"
          >
            ارسال
          </button>
        </form>
      </main>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const params = new URLSearchParams(window.location.search);
        const roomId = params.get("room");
        const title = params.get("title") || "";
        const adminMode =
          params.get("admin") === "1" || params.get("admin") === "true";

        const roomInfo = document.getElementById("roomInfo");
        const messagesBox = document.getElementById("messages");
        const chatStatus = document.getElementById("chatStatus");
        const nameInput = document.getElementById("nameInput");
        const messageInput = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");

        if (!roomId) {
          roomInfo.textContent =
            "شناسه اتاق پیدا نشد. لینک را بررسی کنید.";
          sendBtn.disabled = true;
          return;
        }

        let info = "شناسه اتاق: " + roomId;
        if (title) info = title + " | " + info;
        if (adminMode) info += " | حالت مدیریت فعال است";
        roomInfo.textContent = info;

        // ذخیره نام در localStorage
        const NAME_KEY = "eitaa_comment_name";
        try {
          const savedName = localStorage.getItem(NAME_KEY);
          if (savedName) {
            nameInput.value = savedName;
          }
        } catch {}

        function saveName() {
          const n = nameInput.value.trim();
          if (!n) return;
          try {
            localStorage.setItem(NAME_KEY, n);
          } catch {}
        }
        nameInput.addEventListener("blur", saveName);

        function createMessageElement(c) {
          const wrapper = document.createElement("div");
          wrapper.className = "message";

          const meta = document.createElement("div");
          meta.className = "meta";

          const nameSpan = document.createElement("span");
          nameSpan.className = "meta-name";
          nameSpan.textContent = c.name || "کاربر";

          const timeSpan = document.createElement("span");
          timeSpan.className = "meta-time";
          try {
            const d = new Date(c.timestamp);
            timeSpan.textContent = d.toLocaleString("fa-IR");
          } catch {
            timeSpan.textContent = "";
          }

          meta.appendChild(nameSpan);
          meta.appendChild(timeSpan);

          const text = document.createElement("div");
          text.className = "text";
          text.textContent = c.message || "";

          wrapper.appendChild(meta);
          wrapper.appendChild(text);

          // دکمه حذف در حالت مدیر
          if (adminMode && c.id) {
            const delBox = document.createElement("div");
            delBox.style.marginTop = "4px";

            const btn = document.createElement("button");
            btn.className = "delete-btn";
            btn.textContent = "حذف پیام";
            btn.addEventListener("click", () => {
              handleDelete(c.id);
            });

            delBox.appendChild(btn);
            wrapper.appendChild(delBox);
          }

          return wrapper;
        }

        async function loadComments(scrollToBottom = false) {
          try {
            const res = await fetch(
              `/api/comments/list?roomId=${encodeURIComponent(
                roomId
              )}`
            );
            const data = await res.json();
            if (!data.ok) {
              chatStatus.textContent =
                data.error || "خطا در دریافت کامنت‌ها";
              return;
            }

            const comments = data.comments || [];
            messagesBox.innerHTML = "";

            if (!comments.length) {
              messagesBox.innerHTML =
                "<p class='empty'>اولین نفر باش که نظر می‌گذارد ✨</p>";
              return;
            }

            comments.forEach((c) => {
              const el = createMessageElement(c);
              messagesBox.appendChild(el);
            });

            if (scrollToBottom) {
              messagesBox.scrollTop = messagesBox.scrollHeight;
            }

            chatStatus.textContent = "";
          } catch (err) {
            console.error(err);
            chatStatus.textContent = "خطا در اتصال به سرور.";
          }
        }

        async function sendComment() {
          const name =
            nameInput.value.trim() || "کاربر";
          const message = messageInput.value.trim();
          if (!message) return;

          sendBtn.disabled = true;
          chatStatus.textContent = "در حال ارسال...";

          try {
            const res = await fetch("/api/comments/add", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ roomId, name, message })
            });

            const data = await res.json();
            if (!data.ok) {
              chatStatus.textContent =
                data.error || "خطا در ارسال نظر";
            } else {
              messageInput.value = "";
              saveName();
              await loadComments(true);
              chatStatus.textContent = "نظر شما ثبت شد ✅";
            }
          } catch (err) {
            console.error(err);
            chatStatus.textContent = "خطا در اتصال به سرور.";
          } finally {
            sendBtn.disabled = false;
          }
        }

        async function handleDelete(commentId) {
          if (!confirm("این پیام حذف شود؟")) return;

          try {
            const res = await fetch("/api/comments/delete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ roomId, commentId })
            });
            const data = await res.json();
            if (!data.ok) {
              chatStatus.textContent =
                data.error || "خطا در حذف پیام";
            } else {
              chatStatus.textContent = "پیام حذف شد ✅";
              await loadComments(true);
            }
          } catch (err) {
            console.error(err);
            chatStatus.textContent = "خطا در اتصال به سرور.";
          }
        }

        sendBtn.addEventListener("click", sendComment);

        messageInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            sendComment();
          }
        });

        // بارگذاری اولیه و رفرش دوره‌ای
        loadComments(true);
        setInterval(loadComments, 5000);
      });
    </script>
  </body>
</html>
